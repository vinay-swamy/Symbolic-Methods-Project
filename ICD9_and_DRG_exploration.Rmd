---
title: "R Notebook"
output: html_notebook
---


https://www.cms.gov/Medicare/Medicare-Fee-for-Service-Payment/AcuteInpatientPPS/MS-DRG-Classifications-and-Software
this gets you the ICD10 > DRG mapping 


https://www.cms.gov/Medicare/Medicare-Fee-for-Service-Payment/AcuteInpatientPPS/Downloads/FY2020-FR-Table-5.zip 
This gets you DRG weights 

medicare claims data 
https://data.cms.gov/provider-summary-by-type-of-service/medicare-inpatient-hospitals/medicare-inpatient-hospitals-by-provider-and-service/data/2014


Okay figured out why the DRG descriptions dont match what we have found : THERE ARE TWO(actually 3) KINDS OF DRG CODES!!!!!

CMS/HCFA DRG: older standard used < 2007/8
MS-DRG: current codes
Same 3 digit system, but completely different meanings. Whoever did this should be fired

APR DRG: uses same codes but adds extra stuff for more granularity; these are *in addition* to the other two; ignore these for now

```{r}
library(tidyverse)
library(DBI)

con = dbConnect(RSQLite::SQLite(), 'data/mimic3-1.4/mimic3.db')
con %>% tbl('DRGCODES') %>% collect
tables = read_csv('data/mimic3-1.4/tbl_headers.csv') %>% .[[1]]
load('Rdata/icd_code_reference_and_counts.Rdata')
DRG_codes_raw <- con %>% 
  tbl('DRGCODES') %>% 
  select(-ROW_ID) %>%  
  collect %>% # DRG codes are only supposed to be 3 digits, the 4 digit ones have the severity stuck on the end  
  mutate(DRG_CODE = substr(DRG_CODE, 1, 3))


DRG_codes_raw %>% select(SUBJECT_ID, HADM_ID) %>% distinct %>% nrow


table(DRG_codes_raw$DRG_TYPE)
DRG_codes_raw %>% filter(DRG_TYPE != "APR") %>% select(SUBJECT_ID, HADM_ID) %>% distinct %>% nrow

```


Map CMS-DRG to MS-DRG

found mapping here https://www.kmap-state-ks.us/documents/content/provider/ms-drg%20crosswalk.pdf

```{r}
raw_cms_ms_mapping <- read_csv('~/Downloads/tabula-cms-drg_to_ms-drg.csv', col_names = F) %>% 
  filter(! rowSums(is.na(.)) == ncol(.)   ) %>% 
  mutate(rowid = 1:nrow(.))

mapping_off_1col <- raw_cms_ms_mapping[c(659:677, 724:794), ]


HCFA_to_MS_drg <- bind_rows(
    raw_cms_ms_mapping %>% filter(!is.na(X1) & !is.na(X4)) %>% select(CMS=X1, MS=X4),
  mapping_off_1col %>% filter(!is.na(X1) & !is.na(X5)) %>% select(CMS=X1, MS=X5)
) %>% 
  mutate(CMS = as.numeric(CMS), 
         MS = as.numeric(MS)) %>% 
  filter(!is.na(CMS) & !is.na(MS)) %>% 
  mutate(HCFA = paste0('HC', CMS), 
         MS = paste0("MS", MS)) %>% 
  select(-CMS) %>% 
  distinct()
```

Clean up DRG table 

```{r}
DRG_codes_HCFA <- DRG_codes_raw %>% filter(DRG_TYPE == "HCFA") %>% 
  mutate(HCFA =paste0('HC', DRG_CODE) ) %>% 
  left_join(HCFA_to_MS_drg) %>% 
  select(-DRG_CODE, -HCFA) %>% 
  rename(DRG_CODE = MS)
sum(is.na(DRG_codes_HCFA$DRG_CODE))

diag_DRG_cleaned <-  bind_rows(
  DRG_codes_raw %>% filter(DRG_TYPE == "MS") %>% 
    mutate(DRG_CODE = paste0("MS", DRG_CODE)),
  DRG_codes_HCFA %>% filter(!is.na(DRG_CODE))
) %>% rename(DRG_DESCR = DESCRIPTION)
diag_DRG_cleaned %>% select(SUBJECT_ID, HADM_ID) %>% distinct %>% nrow
```



Now lets tie these to dollar amounts

MIMIC ICD 9  to DRG mapping

```{r}
load('Rdata/ICD9_diag_codes_by_patient_visit.Rdata')

diag_ICD_DRG <- diag_with_admits %>% 
  inner_join(diag_DRG_cleaned %>% select(-DRG_SEVERITY, -DRG_MORTALITY))


```



Method 1: Using medicare claims data 


```{r}
all_medicare_billing_data <- list.files(pattern = "Medicare_Inpatient_Hospitals_by_Provider_and_Service_Data") %>% 
  lapply(function(x) read_csv(x, col_types = rep("c", 15) %>% paste(collapse =""))) %>% bind_rows
sum(unique(all_medicare_billing_data$DRG_Cd) %in% unique(DRG_codes_raw$DRG_CODE))




unique(DRG_codes_raw$DRG_CODE) %>% length
medicare_avg_cost_per_DRG <- all_medicare_billing_data %>% 
  mutate(Avg_Submtd_Cvrd_Chrg = as.numeric(Avg_Submtd_Cvrd_Chrg), 
         Avg_Tot_Pymt_Amt = as.numeric(Avg_Tot_Pymt_Amt),
         Avg_Pymt_Delta = Avg_Tot_Pymt_Amt -  Avg_Submtd_Cvrd_Chrg ) %>% 
  group_by(DRG_Cd) %>% summarise(avg_dollar_sub = mean(Avg_Submtd_Cvrd_Chrg, na.rm =T), 
                                 avg_dollar_rec = mean(Avg_Tot_Pymt_Amt, na.rm = T),
                                 avg_ri_delta = mean(Avg_Pymt_Delta, na.rm = T)) %>% 
  filter(rowSums(is.na(.)) == 0 ) %>% 
  mutate(DRG_CODE = paste0("MS", DRG_Cd)) %>% 
  select(-DRG_Cd)
```


```{r}
decompose_code_weights <- function(tot, prio_seq){
  prio_seq = as.numeric(prio_seq)
  cw = sum(1/prio_seq)
  x = tot/cw 
  return( x * 1/prio_seq)
}
ICD9_mapped_to_medicare_dollar <-  inner_join(diag_ICD_DRG, medicare_avg_cost_per_DRG) %>% 
  group_by(SUBJECT_ID, HADM_ID, DRG_CODE) %>% 
  summarise(SEQ_NUM = SEQ_NUM, 
            ICD9_CODE = ICD9_CODE, 
            DRG_TYPE = DRG_TYPE, 
            DRG_CODE = DRG_CODE,
            avg_dollar_sub=avg_dollar_sub,
            avg_dollar_rec=avg_dollar_rec,
            avg_ri_delta =avg_ri_delta,
            ICD9_dc_avg_dollar_sub = decompose_code_weights(first(avg_dollar_sub), SEQ_NUM),
            ICD9_dc_avg_dollar_rec = decompose_code_weights(first(avg_dollar_rec), SEQ_NUM),
            ICD9_dc_avg_ri_delta = decompose_code_weights(first(avg_ri_delta), SEQ_NUM)
            ) 

estim_dollar_per_ICD9_medicare <- ICD9_mapped_to_medicare_dollar %>% group_by(ICD9_CODE) %>% 
  summarise(avg_estim_dollar_sub = mean(ICD9_dc_avg_dollar_sub), 
            avg_estim_dollar_rec = mean(ICD9_dc_avg_dollar_rec),
            avg_estim_dollar_ri = mean(ICD9_dc_avg_ri_delta)
            )


```

```{r}
N_medicare_DRG = all_medicare_billing_data %>% pull(DRG_Cd) %>% n_distinct()
N_mimic_DRG = DRG_codes_raw %>% pull(DRG_CODE) %>% n_distinct()
N_commmon_DRG = length(intersect(all_medicare_billing_data$DRG_Cd, DRG_codes_raw$DRG_CODE))
N_mappa
```

```{r, fig.width =4}
ggplot(estim_dollar_per_ICD9_medicare %>% mutate(x='')) + 
  geom_boxplot(aes(x=x, y=avg_estim_dollar_sub), width=.5) + 
  ylim(c(0, 20000)) + 
  ylab("Average Submitted Cost") +
  xlab("ICD9 Code") +  + 
  theme_minimal()
  
```

```{r}
ggplot(estim_dollar_per_ICD9_medicare %>% mutate(x='') %>% mutate(frac_ri = avg_estim_dollar_rec / avg_estim_dollar_sub)) + 
  geom_boxplot(aes(x=x, y=frac_ri), width=.5) + 

  ylab("Average Submitted Cost") +
  xlab("ICD9 Code") +   
  theme_minimal()
  
```



Method 2: using BID CMS transparency xml


```{r}

library(xml2)

x <- read_xml("042103881_beth-israel-deaconess-medical-center-inc_standardcharges.xml")
payload <- as_list(x)
v <-  payload$StandardCharges$Facility[[3]][[1]]
t_tags <- c("Descr","GrossCharge", "DiscountCashCharge", "MinNegotiatedCharge", "MaxNegotiatedCharge")
parse_charge_l <- function(charge_l){
  lapply(charge_l, function(x){
  if (length(unlist( x[t_tags])) != 5){
    return(tibble())
  }
  res <- x[t_tags] %>% as.data.frame %>% as_tibble 

  colnames(res) <- t_tags
  res
  }) %>% bind_rows
}

cms_xml_parsed <- lapply(payload$StandardCharges$Facility[3:6], parse_charge_l) %>% bind_rows()

splitl <- function(x, n){
  psl <- str_split(x, " ") %>% unlist
  tibble(DRG =psl[1], MDC = psl[2], MS = psl[n], Description = paste(psl[(n+1):length(psl)], collapse = " "))
}
k <- read_tsv("~/Downloads/MSDRGv39/appendix_A.txt", skip = 11, col_names = "raw", n_max = 17) %>% 
  pull(raw) %>% 
  lapply(function(x) splitl(x, 3)) %>% 
  bind_rows()
j <- read_tsv("~/Downloads/MSDRGv39/appendix_A.txt", skip = 11+17, col_names = "raw") %>% 
  pull(raw) %>% 
  lapply(function(x) splitl(x, 4)) %>% 
  bind_rows()
drg_grouper <- bind_rows(k,j)

drg_grouper$descr_list <- drg_grouper$Description %>% tolower() %>% str_remove_all("^ p |^ m ") %>% str_squish() %>%
  str_replace_all("w/o|w\\./o\\.", "without") %>% 
  str_replace_all("w/", "with") %>% 
  str_replace_all("<|>|/", " ") %>% str_replace_all("\\.|-|,","") %>% 
  str_replace_all("&", " and ") %>% 
  str_split(" ") %>% 
  lapply(function(x) x[x!=""])
cms_xml_parsed$descr_list  <- cms_xml_parsed$Descr %>% tolower %>% 
  str_replace_all("w/o|w\\./o\\.", "without") %>% 
  str_replace_all("w/", "with") %>% 
  str_replace_all("<|>|/", " ") %>% str_replace_all("\\.|-|,","") %>% 
  str_replace_all("&", " and ") %>%  str_split(" ") %>% 
  lapply(function(x) x[x!=""])
m <- lapply(cms_xml_parsed$descr_list, function(x){
          matches <- sapply(seq_along(drg_grouper$descr_list), function(y){
            if(all(x %in% drg_grouper$descr_list[[y]])) return (drg_grouper$DRG[y])
            #else
            return(-1)
            
          } )
          
        if(all(matches == -1)){
          return(-1)
        } else{
          return(matches[matches != -1])
        }
      }
    )
cms_xml_parsed$rc_DRG  = m

cmls_xml_mapped_to_drg <-  cms_xml_parsed %>% filter(sapply(rc_DRG,  function(x) x[1] != -1)) %>% unnest(rc_DRG) %>% select(-descr_list) %>% 
  mutate(DRG_CODE = paste0("MS", rc_DRG), 
         GrossCharge = str_remove_all(GrossCharge, ","),
         GrossCharge = as.numeric(GrossCharge))

cmls_xml_mapped_to_drg %>% pull(DRG_CODE) %>% n_distinct()

cms_avg_cost_per_DRG <- cmls_xml_mapped_to_drg %>% group_by(DRG_CODE) %>% summarise(avg_dollar_sub = mean (GrossCharge))

```


```{r}
ICD9_mapped_to_cms_xml_dollar <-  inner_join(diag_ICD_DRG, cms_avg_cost_per_DRG) %>% 
  group_by(SUBJECT_ID, HADM_ID, DRG_CODE) %>% 
  summarise(SEQ_NUM = SEQ_NUM, 
            ICD9_CODE = ICD9_CODE, 
            DRG_CODE = DRG_CODE,
            ICD9_dc_avg_dollar_sub = decompose_code_weights(first(avg_dollar_sub), SEQ_NUM),
            ) 

estim_dollar_per_ICD9_cms <- ICD9_mapped_to_cms_xml_dollar %>% group_by(ICD9_CODE) %>% 
  summarise(avg_estim_dollar_sub = mean(ICD9_dc_avg_dollar_sub)
            )

```


```{r}
save(estim_dollar_per_ICD9_cms, estim_dollar_per_ICD9_medicare, file = "Rdata/ICD9_estimated_dollar_amounts.Rdata")
```


```{r}
estim_dollar_per_ICD9_medicare %>% arrange(desc(avg_estim_dollar_sub)) %>% tail
```

```{r}
cost_with_counts <-  inner_join(icd_code_counts_annotated,  estim_dollar_per_ICD9_medicare) %>% 
  mutate(frac_rec = avg_estim_dollar_rec/avg_estim_dollar_sub, 
         j= 1/avg_estim_dollar_sub)

spcor <- cost_with_counts %>% select(count, avg_estim_dollar_sub) %>% cor(method = 'spearman') %>% .[1,2] %>% round(2)

ggplot(cost_with_counts, aes(x=count, y = avg_estim_dollar_sub)) + 
  xlim(c(0, 1000))+
  ylim(c(0,100000))+
  geom_point(alpha = .2)  + 
  geom_label(data = tibble(count =750 , avg_estim_dollar_sub = 75000, text = paste("Spearman correlation:", spcor)),
             aes(x=count, y = avg_estim_dollar_sub, label = text)
             )+
  xlab("ICD9 Code Count") + 
  ylab("Average Submitted Cost")+
  theme_minimal() + 
  theme_minimal()

```

```{r}
cost_with_counts_binned <-  cost_with_counts %>%   mutate(count_bin = case_when(
    count ==  0 ~ "0",
    count == 1 ~ "1", 
    count >=2 & count <5 ~ "[2,5)",
    count >=5 & count <25 ~ "[5, 25)",
    count >= 25 ~ ">=25"
  ) ) %>% mutate(count_bin = factor(count_bin, levels = c("0","1","[2,5)","[5, 25)",">=25"))) 
avg_cost_per_bin <- cost_with_counts_binned %>% group_by(count_bin) %>% 
  summarise(avg_cost = mean(avg_estim_dollar_sub)) %>% 
  mutate(k="Average Cost")
aov_lab <- tibble(x=1.5, y=22000, text = summary(k)[[1]][["Pr(>F)"]][1] %>% round(5) %>% {paste0("Anova p value = ",.)} )
ggplot(cost_with_counts_binned) + 
  geom_boxplot(aes(x=count_bin, y=avg_estim_dollar_sub), outlier.shape = NA) + 
  geom_point(data = avg_cost_per_bin, aes(x=count_bin, y=avg_cost ,color =k ))+
  geom_label(data = aov_lab, aes(x=x, y=y, label =text))+
  guides(color = guide_legend(title = ""))+
  theme_minimal()+
  ggtitle("Cost per count bin (outliers not shown)")+
  ylim(c(0,25000)) + 
  xlab("Count Bin") + 
  ylab("Average Submitted Cost")
```

```{r}
library(ggpubr)

ggboxplot(cost_with_counts_binned, x = "count_bin", y='avg_estim_dollar_sub') + 
 
```



```{r}
cost_with_counts %>% select(count, frac_rec) %>% cor(method = 'spearman')
ggplot(cost_with_counts, aes(x=count, y = frac_rec)) + 
  geom_point(alpha = .2) 
```



Below here not relevant 

----

```{r}
d <- tibble(x=c(seq(.01, .1, .001), seq(.1, 1, .01) ) ) %>% 
    mutate(y=1/x ,
           j=1/y)
m <- lm(y~x, data=d)
ggplot(d, aes(x=x, y=j))+
  geom_point() + 
  geom_smooth(method = 'lm')
```


map ICD 10 to DRG

```{r}
ICD102DRG_raw <- data.table::fread(cmd = 'tail -n+10 ~/Downloads/MSDRGv39-2/appendix_B.txt | grep -Ev "^    " |tr -s " "| cut -d" " -f 2,3,4 ',
                               sep = " ", col.names = c("ICD10_CODE", "DX", "DRG_raw")) %>% as.data.frame %>% as_tibble %>% 
  mutate(DRG_l = str_split(DRG_raw, "-") %>% sapply(function(x) first(x) %>% as.numeric() ), 
         DRG_r = str_split(DRG_raw, "-") %>% sapply(function(x) last(x) %>% as.numeric()) )# %>% 


ICD102DRG_msg <- ICD102DRG_raw %>% filter(is.na(DRG_l)|is.na(DRG_r)) %>% 
  mutate(DRG_list = str_split(DRG_raw, ",")) %>% 
  unnest(DRG_list) %>% 
  mutate(DRG_list = as.numeric(DRG_list))
ICD102DRG_range <- ICD102DRG_raw %>% filter(!(is.na(DRG_l)|is.na(DRG_r))) %>% 
  mutate(DRG_list = sapply(1:nrow(.), function(i) seq(.$DRG_l[i], .$DRG_r[i])    )) %>% 
  unnest(DRG_list)
ICD102DRG <-  bind_rows(ICD102DRG_msg, ICD102DRG_range) %>% select(ICD10_CODE, DRG = DRG_list)


```


```{r}
ICD102DRG %>% group_by(DRG) %>% summarise(icd_list = list(unique(ICD10_CODE)))
```



map ICD9 to ICD10

```{r}
ICD9210 <- read_csv("https://data.nber.org/gem/icd10cmtoicd9gem.csv") %>% 
  select(ICD9_CODE = icd9cm, ICD10_CODE = icd10cm)


```


ICD9 to DRG (from MIMIC data)

```{r}
icd_with_drg_long %>% filter(DRG_CODE %in% single_DRGs, ICD9_CODE%in% icd_code_counts_annotated$ICD9_CODE) %>% select(DRG_CODE, ICD9_CODE) %>% distinct %>% filter(!ICD9_CODE %in% ICD9210$ICD9_CODE) %>% pull(ICD9_CODE) %>% n_distinct()
```


ICD9 to DRG (from groupers)


```{r}
ICD9_2_DRG_grouper <-  icd_code_counts_annotated %>% select(ICD9_CODE) %>% inner_join(ICD9210) %>% inner_join(ICD102DRG) %>% select(ICD9_CODE, DRG_CODE=DRG) %>% distinct 
n_distinct(ICD9_2_DRG_grouper$ICD9_CODE)
sum(is.na(ICD9_2_DRG_grouper$DRG_CODE))
n_distinct(ICD9_2_DRG_grouper$DRG_CODE)
```

```{r}
all_medicare_billing_data <- list.files(pattern = "Medicare_Inpatient_Hospitals_by_Provider_and_Service_Data") %>% 
  lapply(function(x) read_csv(x, col_types = rep("c", 15) %>% paste(collapse =""))) %>% bind_rows
sum(unique(all_medicare_billing_data$DRG_Cd) %in% unique(DRG_codes_raw$DRG_CODE))




unique(DRG_codes_raw$DRG_CODE) %>% length
avg_cost_per_DRG <- all_medicare_billing_data %>% 
  mutate(Avg_Submtd_Cvrd_Chrg = as.numeric(Avg_Submtd_Cvrd_Chrg)) %>% 
  group_by(DRG_Cd) %>% summarise(avg_submitted_cost = mean(Avg_Submtd_Cvrd_Chrg, na.rm =T))
```


- need to resolve ICD9> 10 mapping a little better,
- consider using diagnosis ICD sets to further 
- revised dollar assignment: penalize codes that 


```{r}


ICD9_mapped_to_dollar_with_grouper <- ICD9_2_DRG_grouper %>% 
    distinct %>% 
  group_by(DRG_CODE) %>% 
  summarise(icd_list  = list(unique(ICD9_CODE))) %>%
  mutate(DRG_CODE = as.character(DRG_CODE)) %>% 
  inner_join(avg_cost_per_DRG %>% rename(DRG_CODE = DRG_Cd)) %>% 
  group_by(icd_list) %>%
  summarise(avg_cost_per_DRG_SET = mean(avg_submitted_cost),
            drgSet =paste0("DS-", paste(DRG_CODE, collapse = "_"))) %>%
  mutate(icd_set_size = sapply(icd_list, length),
         fractional_cost = avg_cost_per_DRG_SET / icd_set_size) %>% 
  unnest(icd_list)


```


```{r}

counts_with_cost <- ICD9_mapped_to_dollar_with_grouper %>% 
  select(ICD9_CODE = icd_list, estim_cost = avg_cost_per_DRG_SET) %>%  
  inner_join(icd_code_counts_annotated) %>% 
  filter(!is.na(estim_cost)) 
m <- lm(count ~ estim_cost,counts_with_cost )
summary(m)$r.squared

#%>% 
ggplot(counts_with_cost, aes(x = count, y=estim_cost)) + 
  geom_point() +
  xlim(c(1, 100)) +
  geom_smooth(method = 'lm', )


```

```{r}
#used_i9_codes <- icd_code_counts_annotated %>% filter(count > 0) %>% pull(ICD9_CODE)
load("Rdata/ICD9_diag_codes_by_patient_visit.Rdata")
mimic_icd_sets <- diag_with_admits %>% 
  mutate(UID = paste(SUBJECT_ID,HADM_ID, sep = "-")) %>% 
  group_by(UID) %>% 
  summarise(icd_list  = list(unique(ICD9_CODE)))


DRG_icd_sets <-  ICD9_2_DRG_grouper %>% 
    distinct %>% 
  #filter(ICD9_CODE %in% used_i9_codes) %>% 
  group_by(DRG_CODE) %>% 
  summarise(icd_list  = list(unique(ICD9_CODE))) 

jac <- function(l1, l2){
  i = intersect(l1, l2) %>% length
  u = union(l1, l2) %>% length
  return (i/u)
}


mimic_DRG_set_comp <-  lapply(mimic_icd_sets$icd_list,  function( mset) 
               sapply(DRG_icd_sets$icd_list,  function(dset) jac(mset, dset) ) 
       )

```

```{r}
mimic_DRG_set_comp[[1]]
```










